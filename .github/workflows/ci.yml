name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Tests job - runs only on pull requests
  tests:
    name: Run Tests
    runs-on: macos-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.2'

    - name: Install mise
      uses: jdx/mise-action@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install Tuist via mise
      run: |
        mise install tuist@4.95.0
        mise use -g tuist@4.95.0

    - name: Generate Xcode Project
      env:
        TUIST_CONFIG_TOKEN: ${{ secrets.TUIST_CONFIG_TOKEN }}
        CI: 1
      run: |
        tuist clean
        tuist install
        tuist generate
        echo "Generated Xcode project"

    - name: Run Tests
      run: |
        xcodebuild test \
          -workspace ABPlayer.xcworkspace \
          -scheme ABPlayer \
          -destination 'platform=macOS' \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData

  # Build job - runs only on push to main (merge)
  build-only:
    name: Build Only
    runs-on: macos-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.2'

    - name: Install mise
      uses: jdx/mise-action@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }} # Recommended for higher API rate limits

    - name: Install Tuist via mise
      run: |
        mise install tuist@4.95.0
        mise use -g tuist@4.95.0
    - name: Generate Xcode Project
      env:
        TUIST_CONFIG_TOKEN: ${{ secrets.TUIST_CONFIG_TOKEN }}
        CI: 1
      run: |
        tuist clean
        tuist install
        tuist generate
        echo "Generated Xcode project"

    - name: Build App
      run: |
        xcodebuild build \
          -workspace ABPlayer.xcworkspace \
          -scheme ABPlayer \
          -configuration Release \
          -destination 'platform=macOS' \
          -derivedDataPath DerivedData
    
    - name: Upload dSYM to Sentry
      env:
        SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      run: |
        curl -sL https://sentry.io/get-cli/ | sh
        sentry-cli debug-files upload \
          --auth-token "$SENTRY_AUTH_TOKEN" \
          --org "$SENTRY_ORG" \
          --project "$SENTRY_PROJECT" \
          DerivedData/Build/Products/Release/ABPlayer.app.dSYM

    - name: Upload Release App
      uses: actions/upload-artifact@v4
      with:
        name: ABPlayer-Release
        path: DerivedData/Build/Products/Release